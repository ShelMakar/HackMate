{% extends "base.html" %}

{% load static %}

{% block links %}
  <link rel="stylesheet" href="{% static 'css/vacancies/detail.css' %}">
{% endblock %}

{% block content %}
  <div class="container vacancy-container">
    <h1 class="vacancy-title">{{ vacancy.title }}</h1>
    <p class="vacancy-description">{{ vacancy.description }}</p>

    <div class="vacancy-info">
      <p><strong>Создатель:</strong> {{ vacancy.creater.username }}</p>
      <p><strong>Создано:</strong> {{ vacancy.created_at|date:"d.m.Y H:i" }}</p>
      <p><strong>Обновлено:</strong> {{ vacancy.updated_at|date:"d.m.Y H:i" }}</p>
    </div>

    <p class="views">
      <i class="fa-regular fa-eye"></i>{{ vacancy.views.count }}
    </p>

    <button id="respond-button" class="grow-button">Откликнуться</button>

    <section class="commnets">
      <article class="create_comment">
        <h2 class="comments-header">Комментарии</h2>
        <form method="post" action="">
          {% csrf_token %}
          <div class="form-group">
            {{ field.as_p }}
            {% for field in comment_form %}
              <div class="mb-3">
                {{ field }}
                {% if field.help_text %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                  <div class="text-danger">{{ error }}</div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary send-comment">Отправить</button>
        </form>
      </article>
      <article class="comments">
        {% for comment in vacancy.comments.all %}
            <div class="comment">
                <header class="comment-header">
                  <a href="{% url 'users:profile' comment.user.username %}" class="user-a">
                    {% if comment.user.profile.image %}
                    <span class="comment-user"><img src="{{ comment.user.profile.image.url }}" class="user-image">{{ comment.user }}</span>
                    {% else %}
                    <span class="comment-user"><img src="{% static 'img/default-avatar.jpg' %}" class="user-image">{{ comment.user }}</span>
                    {% endif %}
                  </a>
                    <figure>
                      <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                      {% if comment.user == request.user or request.user.is_superuser %}
                      <a href="{% url 'vacancies:delete_comment' comment.pk %}" class="delete-link-form">❌</a>
                      {% endif %}
                    </figure>
                </header>
                <p class="comment-text">{{ comment.comment }}</p>
            </div>
        {% empty %}
            <p class="no-comments">Комментариев пока нет.</p>
        {% endfor %}
    </article>
    </section>
  </div>

  <script>
    document.getElementById("respond-button")?.addEventListener("click", function () {
      fetch("{% url 'vacancies:vacancy_detail' pk=vacancy.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || data.error);
      })
      .catch(error => {
        console.error("Ошибка:", error);
        alert("Произошла ошибка. Попробуйте еще раз.");
      });
    });
  </script>
{% endblock %}
